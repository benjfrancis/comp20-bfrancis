<!DOCTYPE html>
<html>

<head>
        <title>Landmarks</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        
        <link rel="stylesheet" href="style.css" />

        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>

        <script>
                var myLat = 0;
                var myLng = 0;
                var me = new google.maps.LatLng(myLat, myLng);
                var myOptions = {
                        zoom: 13, // The larger the zoom number, the bigger the zoom
                        center: me,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                var map;
                var marker;
                var infowindow = new google.maps.InfoWindow();
                var objects;
                
                function init() {
                        map = new google.maps.Map(document.getElementById('map'), myOptions);
                        getMyLocation();
                }

                function getMyLocation() {
                                if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
                                        navigator.geolocation.getCurrentPosition(function(position) {
                                                myLat = position.coords.latitude;
                                                myLng = position.coords.longitude;
                                                renderObject(myLat, myLng, "ETHAN_VALENZUELA", "me");
                                                objects = getObjects();
                                                //console.log(objects);
                                                //renderMap();
                                                //renderMap2();
                                        });
                                }
                                else {
                                        alert("Geolocation is not supported by your web browser.  What a shame!");
                                }
                }
                /*
                function renderMap() {
                                me = new google.maps.LatLng(myLat, myLng);
                                
                                // Update map and go there...
                                map.panTo(me);
        
                                // Create a marker
                                marker = new google.maps.Marker({
                                        position: me,
                                        title: "Here I Am!"
                                });
                                marker.setMap(map);
                                        
                                // Open info window on click of marker
                                google.maps.event.addListener(marker, 'click', function() {
                                        infowindow.setContent(marker.title);
                                        infowindow.open(map, marker);
                                });
                }
                */

                function renderObject(lat, lng, message, type) {
                                //console.log(lat + ", " + lng);

                                object = new google.maps.LatLng(lat, lng);
                                
                                // Update map and go there...
                                map.panTo(object);
        
                                // Create a marker
                                marker = new google.maps.Marker({
                                        position: object,
                                        title: message
                                });
                                marker.setMap(map);
                                        
                                // Open info window on click of marker
                                google.maps.event.addListener(marker, 'click', function() {
                                        infowindow.setContent(marker.title);
                                        infowindow.open(map, marker);
                                });
                }



                /////////////////////////////////////////////////////////////////////////////////////////
                function getObjects() {
                        var request = new XMLHttpRequest();

                        var objects;

                        var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
                
                        //console.log(myLat + ", " + myLng);

                        var params = "login=ETHAN_VALENZUELA&lat="+  myLat + "&lng=" + myLng;
                        request.open("POST", url, true);

                        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        //request.setRequestHeader("Content-length", params.length);
                        //request.setRequestHeader("Connection", "close");

                        request.onreadystatechange = function() {
                                if(request.readyState == 4 && request.status == 200) {
                                        var raw = request.responseText;
                                        //alert(raw);
                                        var objects = JSON.parse(raw);
                                        objectsOut(objects);
                                        //console.log(objects);

                                }
                        }
                        //console.log(objects);
                        

                        request.send(params);
                        

                        //return objects;
                }

                function objectsOut(objects) {
                        console.log(objects);
                        for (var i = objects["people"].length - 1; i >= 0; i--) {
                                var lat = objects["people"][i]["lat"];
                                var lng = objects["people"][i]["lng"];
                                var message = objects["people"][i]["login"];
                                //console.log(message);
                                renderObject(lat, lng, message, "people");
                                //console.log(i);
                        };
                        
                        for (var i = objects["landmarks"].length - 1; i >= 0; i--) {
                                var lat = objects["landmarks"][i]["geometry"]["coordinates"][0];
                                var lng = objects["landmarks"][i]["geometry"]["coordinates"][1];
                                var message = objects["landmarks"][i]["login"];
                                //console.log(message);
                                renderObject(lat, lng, message, "landmarks");
                                //console.log(i);
                        };
                        
                }



        </script>



</head>

<body onload="init()">
        <div id="map"></div>        
</body>

</html>